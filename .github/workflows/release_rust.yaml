name: Release to crates.io

on:
  push:
    tags:
      - release/rust-v[0-9]+.[0-9]+.[0-9]+


jobs:
  check-versions:
    name: Check and Compare versions across the release tag, core/Cargo.toml, and crates.io
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Get pixelveil Rust crate version
        run: |
          set -euo pipefail

          VERSION=$(cargo metadata \
            --no-deps --format-version 1 --manifest-path core/Cargo.toml | \
            jq -r '.packages[] | select(.name == "pixelveil") | .version')
          
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "Failed to extract version from core/Cargo.toml"
            exit 1
          fi

          echo "TOML_CRATE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Detected pixelveil crate version from core/Cargo.toml: $VERSION"

      - name: Get push tag version
        run: |
          set -euo pipefail

          FULL_PUSH_TAG=${{ github.ref_name }}

          echo "Got push tag: $FULL_PUSH_TAG"

          VERSION=$(echo "$FULL_PUSH_TAG" | grep -o "[0-9]\\+.[0-9]\\+.[0-9]\\+")

          echo "PUSH_TAG_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Got version: $VERSION"
      
      - name: Check core/Cargo.toml and push tag version equality
        run: |
          set -euo pipefail

          if [ "$PUSH_TAG_VERSION" != "$TOML_CRATE_VERSION" ]; then
            echo "Push tag and core/Cargo.toml versions don't match. $PUSH_TAG_VERSION != $TOML_CRATE_VERSION. Exiting"
            exit 1
          fi

          echo "Setting CRATE_VERSION variable"
          echo "CRATE_VERSION=$PUSH_TAG_VERSION" >> $GITHUB_ENV
      
      - name: Check that released version does not exist on crates.io
        run: |
          set -euo pipefail

          CRATE_NAME=pixelveil

          echo "Querying crates.io for $CRATE_NAME versions"

          EXISTING=$(curl -fsSL \
            "https://crates.io/api/v1/crates/$CRATE_NAME" \
            | jq -r ".versions[].num" \
            | grep -Fx "$CRATE_VERSION" || true)

          if [ -n "$EXISTING" ]; then
            echo "::error::Version $CRATE_VERSION of crate '$CRATE_NAME' already exists on crates.io"
            exit 1
          fi

          echo "Version $CRATE_VERSION does not exist on crates.io â€” OK"
  
  build-and-test:
    name: Build and Test Crate
    runs-on: ubuntu-latest
    needs: [check-versions]

    steps:  
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable 
        
      - name: Build with Release Profile
        run: |
          set -euo pipefail
          cargo build --release
      
      - name: Test crate
        run: |
          set -euo pipefail
          cargo test --all-targets

  deploy:
    name: Deploy to crates.io
    runs-on: ubuntu-latest
    needs: [build-and-test]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Login into cargo
        run: |
          cargo login ${{ secrets.CARGO_REGISTRY_TOKEN }}
      
      - name: Publish to crates.io
        run: |
          cargo publish --package pixelveil
