name: Release to all

on:
  release:
    types: [published]

jobs:
  check-version-consistency:
    name: Check version consistency across project
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Extract and save core pixelveil Rust crate version
        id: rust_core_version
        run: |
          set -euo pipefail

          VERSION=$(cargo metadata \
            --no-deps --format-version 1 | \
            jq -r '.packages[] | select(.name == "pixelveil") | .version')
          
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "Failed to extract version from core/Cargo.toml"
            exit 1
          fi

          echo "rust_core_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected core Pixelveil crate version: $VERSION"
        
      - name: Extract and save python wrapper pixelveil_pyo3 Rust crate version
        id: rust_pyo3_version
        run: |
          set -euo pipefail

          VERSION=$(cargo metadata \
            --no-deps --format-version 1 | \
            jq -r '.packages[] | select(.name == "pixelveil_pyo3") | .version')
          
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "Failed to extract version from python/Cargo.toml"
            exit 1
          fi

          echo "rust_pyo3_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected PyO3 Pixelveil crate version: $VERSION"
